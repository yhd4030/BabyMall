<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/css/cart.css}"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/bs.css}"/>
    <link rel="stylesheet" th:href="@{/css/mc-dialoger.css}"/>

    <script type="text/javascript" th:src="@{/js/jquery-3.4.1.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/dialoger.js}"></script>
    <script type="text/javascript" th:src="@{/js/domlastic.js}"></script>
    <script type="text/javascript">

        /**
         * 解决ajax异步带来的问题
         * @param d
         */
        function sleep(d) {
            var t = Date.now();
            while (Date.now - t <= d) ;
        }

        function checkOrNot(bookId, unitPrice, obj) {
            $.post(
                "cart/checkOne",
                {"bookId": bookId},
                function (data) {
                    if (data.code == 200) {
                        //当前购物项
                        var $cartItem = $("#cart_item" + bookId);

                        var $buy_num = $cartItem.find(".buy_num");
                        var num = parseInt($buy_num.val());
                        var $subTotal = $cartItem.find(".subTotal");
                        var $shopTotal = $(".shop_total");
                        var shop_total_text = $shopTotal.text().trim();

                        if ($(obj).is(":checked")) {
                            var subTotal = unitPrice * num;
                            $subTotal.text(subTotal);

                            var shop_total = (parseFloat(shop_total_text.substring(shop_total_text.indexOf("￥") + 1)) + subTotal).toFixed(2);
                            $shopTotal.text("￥" + shop_total);
                        } else {
                            var subTotal = (unitPrice * num).toFixed(2);
                            var shop_total = (parseFloat(shop_total_text.substring(shop_total_text.indexOf("￥") + 1)) - subTotal).toFixed(2);
                            $subTotal.text("0.00");
                            $shopTotal.text("￥" + shop_total);
                        }
                    }
                },
                "json"
            );
        }

        //点击增加购买书本的数量，并计算小计和总数
        function add(id, unitPrice) {
            var $cartItem = $("#cart_item" + id);
            // if (!$($cartItem).find(".shop_checkbox").prop("checked")) {
            //     $($cartItem).find(".shop_checkbox").prop("checked", true)
            // }

            var $checkbox = $($cartItem).find(".shop_checkbox");
            var buyNum = $("#buyNum" + id).val();
            $("#buyNum" + id).val(parseInt(buyNum) + 1);

            $("#subTotal" + id).html((Math.floor((parseInt(buyNum) + 1) * unitPrice) * 100) / 100);

            if ($checkbox.prop("checked")) {
                $("#all_total").text(unitPrice + parseFloat($("#all_total").text()) + "￥");
            }
            totalAjax(id);
        }

        //点击减少购买书本的数量，并计算小计和总数
        function sub(id, unitPrice) {
            var $cartItem = $("#cart_item" + id);
            // if (!$($cartItem).find(".shop_checkbox").prop("checked")) {
            //     $($cartItem).find(".shop_checkbox").prop("checked", true)
            // }
            var $checkbox = $($cartItem).find(".shop_checkbox");
            var buyNum = parseInt($("#buyNum" + id).val());
            var subTotal = parseFloat($("#subTotal" + id).html());
            var allTotal = parseFloat($("#all_total").html());
            if (buyNum != 1) {
                $("#buyNum" + id).val(buyNum - 1);
                $("#subTotal" + id).html((Math.floor((parseFloat(buyNum) - 1) * unitPrice) * 100) / 100);
                if ($checkbox.prop("checked")) {
                    if (allTotal > 0) {
                        $("#all_total").text((parseFloat($("#all_total").text()) - unitPrice) + "￥");
                    } else {
                        $("#all_total").text(0 + "￥");
                    }

                }
                totalAjax(id);
            }
        }

        // 计算总数的ajax
        function totalAjax(id) {
            $.ajax({
                type: "post",
                url: "/product/cart/addOrSub",
                data: {id: id, amount: $("#buyNum" + id).val()},
                dataType: "json",
                success: function (data) {
                    $("#total").html(data)
                }
            });
        }

        //计算总金额
        function checkTotal(id) {
            var $cartItem = $("#cart_item" + id);
            var $checkbox = $($cartItem).find(".shop_checkbox");
            var subTotal = parseFloat($("#subTotal" + id).html());
            var allTotal = parseFloat($("#all_total").html());
            if ($checkbox.prop("checked")) {
                $("#all_total").text(subTotal + allTotal + "￥");
            } else {
                if (allTotal - subTotal > 0) {
                    $("#all_total").text((allTotal - subTotal) + '￥');
                } else {
                    $("#all_total").text(0 + '￥');
                }

            }
        }

        function deleteCartItem(id) {
            var $cartItem = $("#cart_item" + id);
            dialoger.$confirm({
                mes: '确认移出购物车?',
                callback: function () {
                    $.ajax({
                        type: "post",
                        url: "/product/cart/delete",
                        data: {id: id},
                        success: function (data) {
                            if (data == true) {
                                dialoger.$toast({mes: '移出成功！！'})
                                domLastic.init({
                                    itemsClassnameToConnect: 'cart_item', //类选择器
                                    itemsJointStrength: 10, //value optimum between 10 - 100
                                    animationSpeed: 500, //value optimum 300 - 1000 动画速度
                                    animationIntensity: 0.6, //value optimum optimum 0.5 - 1
                                    animationDirection: 'horizontal', //动画方向
                                    callback: function () {
                                        console.log('anim finished');
                                    }
                                });
                                domLastic.animateItems();
                                $($cartItem).slideToggle(150, function () {
                                    $($cartItem).remove();
                                    //aniamte ListItems
                                    domLastic.animateItems();
                                });
                            }
                        }
                    })

                }
            });
        }


        function submitOrder() {
            var bookIdStr = "";
            var count = 0;
            var cks = document.getElementsByName("cks");
            for (var i = 0; i < cks.length; i++) {
                if (cks[i].checked) {
                    bookIdStr = $(cks[i]).attr("id") + "," + bookIdStr;
                    count++;
                }
            }
            alert(bookIdStr)
            if (count == 0) {
                dialoger.$toast({mes: '请选择商品', timeout: 3000});
            } else {
                $.ajax({
                    method: "post",
                    url: "/order/details",
                    data: {bookIdStr: bookIdStr},
                    dataType: "json",
                    success: function (data) {
                        window.location.href = "/order/info?source=buy";
                    }
                });
            }


        }
    </script>
</head>
<body>
<div th:insert="~{top ::top}"></div>
<div class="container">
    <!--
        购物车头部
    -->
    <div class="row" style="padding-left: 100px;">
        <!--        <img src="img/2018102616575937187.jpg" alt="广告"/>-->
    </div>
    <div class="row cartheader">
        <div class="col-lg-2 col-md-4 col-sm-6 col-xs-12 img_div">
            <!--            <a href="index.html" target="_blank"><img th:src="@{/images/dd.jpg}" width="90%" alt="dd.com"/></a>-->
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 col-xs-12 cart_text_div">
            <span class="cart_text_span">购物车</span>
        </div>
        <div class="col-lg-8 col-md-12 col-sm-12 col-xs-12 process">
            <span class="cart_text" id="this_process">我的购物车</span>
            <span class="cart_text">填写订单</span>
            <span class="cart_text">完成订单</span>
        </div>
    </div>
    <div class="clear"></div>

</div>
<div style="height: 3px; background-color: #ff2832;"></div>

<div class="container">

    <!--
        购物车主体
    -->

    <div th:if="${carts.size()==0}" class="row">
        <h1 class="h1">亲，您的购物车为空，<a href="/">再逛一逛吧!</a></h1>
        <img src="/images/cartNothing.jpg" alt="您的购物车为空">
    </div>


    <div th:if="${carts.size()!=0}" class="row" id="cart_table_div">
        <table id="cart_table">
            <thead>
            <tr id="table_head">
                <th width="10%">
                    <input type="checkbox" class="select_all" checked/>店铺全选
                </th>
                <th class="labelCenter" width="30%">商品信息</th>
                <th class="labelCenter" width="10%">单价（元）</th>
                <th class="labelCenter" width="10%">数量</th>
                <th class="labelCenter" width="10%">小计（元）</th>
                <th class="labelCenter" width="10%">操作</th>
            </tr>
            </thead>
            <tbody>
            <tr class="shop_intro">
                <td class="tcol1">
                    <input type="checkbox" class="select_all_oneShop" checked/>
                    <span>全选</span>
                </td>
                <td>
                    <span>dd(店铺)</span>
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <!--                <c:forEach items="${cart.cartItems}" var="cartItem">-->

            <tr class="cart_item" th:id="'cart_item'+${cart.id}" th:each="cart:${carts}">
                <td class="tcol1 labelCenter">
                    <!--                            ${cartItem.value.checked?'checked':''} onchange="checkOrNot(${cartItem.value.bookInfo.bookId},${cartItem.value.bookInfo.price},this)"-->
                    <input name="cks" type="checkbox" class="shop_checkbox" th:id="${cart.id}" th:onclick="|checkTotal(${cart.id})|"/>
                </td>
                <td class="labelCenter">
                    <a href="#"><img th:src="${cart.PImg}" width="20%"/></a>
                    <span th:text="${cart.getPName()}"
                          style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;width: 260px;display: inline-block;"></span>
                </td>
                <td class="labelCenter">
                    <span class="red" th:text="'￥'+${cart.getRealPrice()}"></span>
                </td>
                <td class="labelCenter">
                    <div class="num">
                        <input type="text" disabled class="buy_num" th:id="${'buyNum'+cart.id}"
                               th:value="${cart.amount}"/>
                        <a href="javascript:void(0);" class="num_add"
                           th:onclick="|add(${cart.id},${cart.realPrice})|">+</a>
                        <a href="javascript:void(0);" class="num_sub"
                           th:onclick="|sub(${cart.id},${cart.realPrice})|">-</a>
                    </div>
                </td>
                <td class="labelCenter">
                    <span class="red" th:id="${'subTotal'+cart.id}"
                          th:text="${cart.realPrice.multiply(cart.amount).setScale(2)}">￥</span>
                    <span class="red subTotal"></span>
                </td>
                <td class="labelCenter">
                    <button class="delete_btn" th:onclick="|deleteCartItem(${cart.id})|">
                        删除
                    </button>
                </td>
            </tr>
            <tr class="tfoot">
                <td class="tcol1">
                    <span>店铺合计	</span>
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td id="total" class="shop_total" th:text="'￥'+${totalPrice}">
                    <!--                        <fmt:formatNumber type="number" value="${cart.total}" pattern="0.00"/>-->
                </td>
            </tr>

            </tbody>

        </table>
    </div>

    <!--
    去结算div
    -->
    <div class="row account_div">
        <div id="batch">
            <a href="cart/clear">清空购物车</a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="" style="font-size: 20px;color: #000000">继续购物</a>
        </div>
        <div id="shopping_total">
            <p class="total_p">
                <span>总计：</span>
                <span id="all_total">
                        0￥
                </span>
            </p>
            <a href="javascript:void(0);" class="total_btn" onclick="submitOrder()">填写订单</a>
        </div>
    </div>
    <!--    </c:if>-->

</div>
<div class="clear"></div>
</body>
</html>